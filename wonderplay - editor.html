<!DOCTYPE html>
<html>
<head>
	<title>Wonder Editor</title>
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link 
	 as="style"
	 rel="stylesheet preload prefetch" 
	 href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400&family=Teko:wght@300;400;500;600&display=swap" 
	 type="text/css" 
	 crossorigin="anonymous" />
	 
	<script type="text/javascript" src="scripts/jquery.min.js"></script>
	<style type="text/css">
		*{ 
			-webkit-box-sizing: border-box;
       		-moz-box-sizing: border-box;
            box-sizing: border-box;
		}
		body{
			margin: 0;
		}
		#frame-1{
			position: absolute;
			width: 50%;
			height: 100%;
			background-color: black;
			left: 0;
		}
		#frame-2{
			position: absolute;
			width: 50%;
			height: 100%;
			background-color: red;
			right: 0;
		}
		#frame-3{
			position: absolute;
			width: 80%;
			height: 100%;
			background-color: teal;
			top: 50%;
			left: 50%;
			transform: translate(-50%,-50%);
		}
		.title{
			width: 100%;
			padding-top:10px;
			text-align: center;
			font-size: 40px;
			font-family: 'Teko', sans-serif;
		}
		.flex{
			display: flex;
			justify-content: center;
		}
		.margin-10{
			margin: 10px
		}
		#lyrics-box{
			width:100%;
			min-height: 80%;
			max-height: 100%;
			overflow: hidden;
			padding: 20px;
		}
		#formatted-lyrics{
			overflow: hidden;
		}
		textarea {
			width:100%;
			height:80vh;
		}
		.time{
			color: blue;
		}
	</style>
</head>
<body>
	<div id="frame-1">
		<div>
			<video id="player" controls="">
				<source src="videos/floating_kokoro.mp4" type="">
			</video>
		</div>
	</div>
	<div id="frame-2">
		<div id="formatted-lyrics" class="margin-10"></div>
		<input type="button" value="Previous" id="prev">
		<input type="button" value="Next" id="next">
		<input type="button" value="Next + Apply" id="next-apply">
		<input type="button" value="Change" id="change">
	</div>
	<div id="frame-3">
		<div class="title">Enter your lyrics here</div>
		<div class="flex"><div class="margin-10">Make sure all the lines you want are broken down the way you want</div><div class="margin-10">Language : [Dropdown]</div></div>
		<div id="lyrics-box">
			<textarea id="lyrics"></textarea>
			<input id="ok" type="button" value="Ok">
		</div>
	</div>
	<script type="text/javascript">
		// Calculate width of text from DOM element or string. By Phil Freo <http://philfreo.com>
		$.fn.textWidth = function(text, font) {
		    if (!$.fn.textWidth.fakeEl) $.fn.textWidth.fakeEl = $('<span>').hide().appendTo(document.body);
		    $.fn.textWidth.fakeEl.text(text || this.val() || this.text()).css('font', font || this.css('font'));
		    return $.fn.textWidth.fakeEl.width();
		};

		var formatted_lyrics = $('#formatted-lyrics');
		var lyrics_divs
		var lyrics_array = []
		var timecode = [];
		var player = document.getElementById('player')

		$('#ok').on('click',() => {
			var lyrics = $('#lyrics').val().split('\n')
			console.log($('#lyrics').val().split('\n'))
			$('#frame-3').css('display','none')
			var k = 0
			for(let line of lyrics){
				line = line.trim()
				lyrics_array.push(line)
				let div = $('<div>');
				let span = $('<span>')
				let span2 = $('<span>')
				let span3 = $('<input type="text">')
				span.attr('class','addbtn')
				span2.attr('class','lyr')
				span3.attr('class','time')
				span3.css('display','none')
				span.html('add ')
				span2.html(line)
				span.appendTo(div)
				span2.appendTo(div)
				span3.appendTo(div)
				//span2.data('index',k)
				span2.on('click',{
					"index":k
				},lyrClick)
				span3.on('focusout',{
					"index":k
				},checkVal)
				div.appendTo(formatted_lyrics)
				k++
			}
			lyrics_divs = $('#formatted-lyrics > div')
			var input = $('.time')
			input.on('input',(e) => {
				setWidth($(e.target))
			}); 

		})
		function setWidth(jelem){
			extra_w = $("<input class='time'>").html('00').textWidth()
			console.log(jelem.textWidth() + extra_w)
			jelem.css('width',jelem.textWidth() + extra_w + "px")
		}
		function lyrClick(e){
			console.log(e.data)
			let index = e.data.index
			if(timecode[index]){
				player.currentTime = timecode[index]
			}
		}

		function checkVal(e){
			let box = $(e.target)
			let index = e.data.index
			let value = parseFloat(box.val().trim())
			if(value == NaN){
				box.val(timecode[index])
				setWidth(box)
			}else{
				if(((timecode[index-1] || 0) < value)&&(value < (timecode[index+1] || player.duration))){
					console.log('002')
					timecode[index] = value
					box.val(" " + value)
					setWidth(box)
				}else{
					box.val(" " + timecode[index])
					setWidth(box)
					console.log("The changetime has to be in between")
				}
			}
			console.log()
		}
		var i = 0,j=0,sync = 0;
		//console.log($('#formatted-lyrics > div'))
		$('#next-apply').on('click',() =>{
			if(i>=0 && i < lyrics_divs.length){
				if(i < timecode.length - 1){
					i = timecode.length -1
					player.currentTime = timecode[timecode.length -1]
				}else{
					timecode[i] = player.currentTime
				}
				let line_now = $(lyrics_divs[i]);
				line_now.find('.time').val(" " + timecode[i])
				setWidth(line_now.find('.time'))
				line_now.find('.time').css('display','inline')
				lyrics_divs.css('border','none')
				lyrics_divs.css('background-color','#ff000000')
				line_now.css('background-color','white')
				if(i < lyrics_divs.length - 1) i++;
			}
		})
		$('#change').on('click',() => {
			if(((timecode[i-1] || 0) < player.currentTime)&&(player.currentTime < (timecode[i+1] || player.duration))){
				timecode[i] = player.currentTime
				let line_now = $(lyrics_divs[i]);
				line_now.find('.time').val(" " + timecode[i])
				setWidth(line_now.find('.time'))
			}else{
				console.log("The changetime has to be in between")
			}
		})
		$('#next').on('click',() => {
			if(i < timecode.length - 1){	
				i++
				player.currentTime = timecode[i]
				let line_now = $(lyrics_divs[i]);
				lyrics_divs.css('background-color','#ff000000')
				line_now.css('background-color','white')
			}
			if(i == timecode.length - 1){
				i++
			}
		})
		$('#prev').on('click',() => {
			if(i > 0){
				i--
				player.currentTime = timecode[i]
				let line_now = $(lyrics_divs[i]);
				lyrics_divs.css('background-color','#ff000000')
				line_now.css('background-color','white')
			}
		})
		var stop_update 
		function update(argument) {
			if(player.currentTime + sync > timecode[j] && player.currentTime + sync < timecode[j+1]){
				let line_now = $(lyrics_divs[j]);
				lyrics_divs.css('border','none')
				line_now.css('border','1px solid white')
				//console.log(j)
				j++
				stop_update = false
			}
			if(j == timecode.length - 1 && player.currentTime > timecode[j] && !stop_update){
				let line_now = $(lyrics_divs[j]);
				lyrics_divs.css('border','none')
				line_now.css('border','1px solid white')
				stop_update = true
			}
		}
		var updater;
		var interval = true;
		var start,stop,seek;

		start = function (){
			if(interval){
				updater = setInterval(update,10);
				interval = false;
			}
		}
		stop = function (){
			if(!interval){
				clearInterval(updater); 
				interval = true;
			}
		}

		var done
		seek = function(){
			//player.pause();
			done = false;
			console.log("seeking")
			j = 0;
			timecode.forEach(check);
			//player.play();
		}
		function check(item,index) {
			if(item > player.currentTime + sync && !done){
				j = index - 1;
				//console.log(index + 'kkkkkkkkkkkk');
				if(j<0){
					j=0;
				}
				done = true;
				lyrics_divs.css('border','none')
				$(lyrics_divs[j]).css('border','1px solid white')
			}
		}
		player.addEventListener("seeked", async function() {seek(); start();player.play();});
		player.addEventListener("play",function() {seek(); start(); /*animation1();*/});
		player.addEventListener("pause",function(){stop();});
		player.addEventListener("ended",function(){ console.log("ended"); stop();});
	</script>
</body>
</html>